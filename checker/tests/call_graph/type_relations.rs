// Copyright (c) Facebook, Inc. and its affiliates.
//
// This source code is licensed under the MIT license found in the
// LICENSE file in the root directory of this source tree.
//
// Testing derivation of type relations with heuristics.

#[derive(Debug, Clone, PartialEq, Eq, Hash)]
struct Foo {
    x: u32,
}

fn foo_ref(f: &Foo) {
    println!("{}", f.x);
}

fn foo_mut_ref(f: &mut Foo) {
    f.x = 0;
    println!("{}", f.x);
}

fn foo_slice_iter(fs: &[Foo]) {
    for f in fs.iter() {
        println!("{}", f.x);
    }
}

fn foo_vec_iter(fs: Vec<Foo>) {
    for f in fs.iter() {
        println!("{}", f.x);
    }
}

pub fn main() {
    let mut f1 = Foo { x: 1 };
    foo_ref(&f1);
    foo_mut_ref(&mut f1);

    let f2 = vec![Foo { x: 0 }, Foo { x: 1 }];
    foo_slice_iter(&f2);
    foo_vec_iter(f2);
}

/* CONFIG
{
    "reductions": ["Fold", "Clean"],
    "included_crates": [
        "type_relations"
    ],
    "datalog_config": {
        "datalog_backend": "DifferentialDatalog",
        "type_relations_path": "tests/call_graph/type_relations.json"
    }
}
*/

/* EXPECTED:DOT
digraph {
    0 [ label = "\"type_relations::main\"" ]
    1 [ label = "\"type_relations::foo_ref\"" ]
    2 [ label = "\"type_relations::foo_mut_ref\"" ]
    3 [ label = "\"type_relations::foo_slice_iter\"" ]
    4 [ label = "\"type_relations::foo_vec_iter\"" ]
    0 -> 1 [ ]
    0 -> 2 [ ]
    0 -> 3 [ ]
    0 -> 4 [ ]
}
*/

/* EXPECTED:DDLOG
start;
insert Dom(1,2);
insert Dom(1,3);
insert Dom(1,4);
insert Dom(2,3);
insert Dom(2,4);
insert Dom(3,4);
insert Edge(0,0,1);
insert Edge(1,0,2);
insert Edge(2,0,3);
insert Edge(3,0,4);
insert EdgeType(0,0);
insert EdgeType(1,6);
insert EdgeType(2,26);
insert EdgeType(3,44);
insert EqType(0,47);
insert EqType(0,48);
insert EqType(0,6);
insert EqType(26,44);
insert EqType(26,46);
insert EqType(46,44);
insert EqType(48,47);
insert EqType(6,47);
insert EqType(6,48);
insert Member(26,0);
insert Member(26,47);
insert Member(26,48);
insert Member(26,6);
insert Member(44,0);
insert Member(44,47);
insert Member(44,48);
insert Member(44,6);
insert Member(45,46);
insert Member(46,0);
insert Member(46,47);
insert Member(46,48);
insert Member(46,6);
commit;
*/

/* EXPECTED:TYPEMAP
{
  "0": "&Foo",
  "6": "&mut Foo",
  "26": "&[Foo]",
  "44": "std::vec::Vec<Foo>",
  "45": "Bar",
  "46": "[test::Foo]",
  "47": "test::Foo",
  "48": "Foo"
}
*/

/* EXPECTED:CALL_SITES
{
  "files": [
    "tests/call_graph/type_relations.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/core/src/mem/valid_align.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/core/src/ptr/mod.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/core/src/ptr/non_null.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/core/src/ptr/unique.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/core/src/ptr/const_ptr.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/core/src/ptr/mut_ptr.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/core/src/fmt/mod.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/core/src/result.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/core/src/slice/mod.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/core/src/slice/iter.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/core/src/slice/raw.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/core/src/alloc/layout.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/alloc/src/raw_vec.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/alloc/src/alloc.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/alloc/src/boxed.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/alloc/src/slice.rs",
    "/rustc/4c5f6e6277b89e47d73a192078697f7a5f3dc0ac/library/alloc/src/vec/mod.rs"
  ],
  "callables": [
    [
      "type_relations.implement.fmt",
      false
    ],
    [
      "core.fmt.builders.implement_core_fmt_builders_DebugStruct.finish",
      true
    ],
    [
      "type_relations.foo_ref",
      false
    ],
    [
      "core.fmt.implement_core_fmt_ArgumentV1.new_display",
      false
    ],
    [
      "type_relations.foo_mut_ref",
      false
    ],
    [
      "type_relations.foo_slice_iter",
      false
    ],
    [
      "core.slice.implement.iter",
      false
    ],
    [
      "core.slice.iter.implement_core_slice_iter_Iter_generic_par_T.next",
      false
    ],
    [
      "type_relations.foo_vec_iter",
      false
    ],
    [
      "alloc.vec.implement_alloc_vec_Vec_generic_par_T_generic_par_A.drop",
      false
    ],
    [
      "type_relations.main",
      false
    ],
    [
      "alloc.vec.implement_alloc_vec_Vec_generic_par_T_generic_par_A.deref",
      false
    ],
    [
      "std.io.stdio._print",
      true
    ],
    [
      "core.fmt.implement_core_fmt_Arguments.new_v1",
      false
    ],
    [
      "core.mem.valid_align.implement.as_nonzero",
      false
    ],
    [
      "core.num.nonzero.implement_core_num_nonzero_NonZeroUsize.new_unchecked",
      true
    ],
    [
      "core.ptr.null",
      false
    ],
    [
      "core.ptr.invalid",
      false
    ],
    [
      "core.ptr.null_mut",
      false
    ],
    [
      "core.ptr.invalid_mut",
      false
    ],
    [
      "core.ptr.slice_from_raw_parts",
      false
    ],
    [
      "core.ptr.metadata.from_raw_parts",
      false
    ],
    [
      "core.ptr.const_ptr.implement.cast",
      false
    ],
    [
      "core.ptr.slice_from_raw_parts_mut",
      false
    ],
    [
      "core.ptr.metadata.from_raw_parts_mut",
      false
    ],
    [
      "core.ptr.mut_ptr.implement.cast",
      false
    ],
    [
      "core.ptr.non_null.implement_core_ptr_non_null_NonNull_generic_par_T.new",
      false
    ],
    [
      "core.ptr.mut_ptr.implement.is_null",
      false
    ],
    [
      "core.ptr.non_null.implement_core_ptr_non_null_NonNull_generic_par_T.new_unchecked",
      false
    ],
    [
      "core.ptr.non_null.implement_core_ptr_non_null_NonNull_slice_generic_par_T.slice_from_raw_parts",
      false
    ],
    [
      "core.ptr.non_null.implement_core_ptr_non_null_NonNull_generic_par_T.as_ptr",
      false
    ],
    [
      "core.ptr.non_null.implement_core_ptr_non_null_NonNull_slice_generic_par_T.as_non_null_ptr",
      false
    ],
    [
      "core.ptr.mut_ptr.implement_pointer_mut_slice_generic_par_T.as_mut_ptr",
      false
    ],
    [
      "core.ptr.non_null.implement_core_ptr_non_null_NonNull_slice_generic_par_T.as_mut_ptr",
      false
    ],
    [
      "core.ptr.unique.implement_core_ptr_unique_Unique_generic_par_T.new_unchecked",
      false
    ],
    [
      "core.ptr.unique.implement_core_ptr_unique_Unique_generic_par_T.as_ptr",
      false
    ],
    [
      "core.ptr.unique.implement_core_ptr_unique_Unique_generic_par_T.from",
      false
    ],
    [
      "core.ptr.unique.implement_core_ptr_unique_Unique_generic_par_T.from",
      false
    ],
    [
      "core.ptr.non_null.implement_core_ptr_non_null_NonNull_generic_par_T.from",
      false
    ],
    [
      "core.ptr.const_ptr.implement.is_null",
      false
    ],
    [
      "core.ptr.const_ptr.implement.guaranteed_eq",
      false
    ],
    [
      "core.intrinsics.foreign_1.ptr_guaranteed_eq",
      true
    ],
    [
      "core.ptr.const_ptr.implement.add",
      false
    ],
    [
      "core.ptr.const_ptr.implement.offset",
      false
    ],
    [
      "core.ptr.const_ptr.implement.wrapping_add",
      false
    ],
    [
      "core.ptr.const_ptr.implement.wrapping_offset",
      false
    ],
    [
      "core.ptr.mut_ptr.implement.guaranteed_eq",
      false
    ],
    [
      "core.result.implement_core_result_Result_generic_par_T_generic_par_F.from_residual",
      false
    ],
    [
      "core.convert.implement_generic_par_T.from",
      false
    ],
    [
      "core.fmt.implement_core_fmt_ArgumentV1.new",
      false
    ],
    [
      "core.slice.iter.implement_core_slice_iter_Iter_generic_par_T.new",
      false
    ],
    [
      "core.slice.implement.as_ptr",
      false
    ],
    [
      "core.intrinsics.foreign_1.assume",
      true
    ],
    [
      "core.mem.size_of",
      false
    ],
    [
      "core.slice.iter.implement_core_slice_iter_Iter_generic_par_T.post_inc_start",
      false
    ],
    [
      "core.ptr.mut_ptr.implement.offset",
      false
    ],
    [
      "core.slice.raw.from_raw_parts",
      false
    ],
    [
      "core.alloc.layout.implement.from_size_align_unchecked",
      false
    ],
    [
      "core.mem.valid_align.implement.new_unchecked",
      true
    ],
    [
      "core.alloc.layout.implement.dangling",
      false
    ],
    [
      "core.alloc.layout.implement.align",
      true
    ],
    [
      "alloc.slice.implement.into_vec",
      false
    ],
    [
      "alloc.alloc.exchange_malloc",
      true
    ],
    [
      "alloc.raw_vec.implement_alloc_raw_vec_RawVec_generic_par_T_generic_par_A.from_raw_parts_in",
      false
    ],
    [
      "alloc.raw_vec.implement_alloc_raw_vec_RawVec_generic_par_T_generic_par_A.ptr",
      false
    ],
    [
      "alloc.alloc.alloc",
      false
    ],
    [
      "core.alloc.layout.implement.size",
      true
    ],
    [
      "alloc.alloc.alloc_zeroed",
      false
    ],
    [
      "alloc.alloc.implement_alloc_alloc_Global.allocate",
      false
    ],
    [
      "alloc.alloc.implement.alloc_impl",
      true
    ],
    [
      "alloc.boxed.implement_alloc_boxed_Box_generic_par_T_generic_par_A.into_raw_with_allocator",
      false
    ],
    [
      "alloc.boxed.implement_alloc_boxed_Box_generic_par_T_generic_par_A.into_unique",
      false
    ],
    [
      "core.ptr.read",
      false
    ],
    [
      "alloc.boxed.implement_alloc_boxed_Box_generic_par_T_generic_par_A.leak",
      false
    ],
    [
      "alloc.boxed.implement_alloc_boxed_Box_generic_par_T_generic_par_A.drop",
      false
    ],
    [
      "core.mem.manually_drop.implement.new",
      false
    ],
    [
      "core.mem.manually_drop.implement_core_mem_manually_drop_ManuallyDrop_generic_par_T.deref",
      false
    ],
    [
      "alloc.slice.hack.into_vec",
      false
    ],
    [
      "core.slice.implement.len",
      false
    ],
    [
      "alloc.vec.implement_alloc_vec_Vec_generic_par_T_generic_par_A.from_raw_parts_in",
      false
    ],
    [
      "alloc.vec.implement_alloc_vec_Vec_generic_par_T_generic_par_A.as_ptr",
      false
    ],
    [
      "alloc.vec.implement_alloc_vec_Vec_generic_par_T_generic_par_A.as_mut_ptr",
      false
    ],
    [
      "core.ptr.drop_in_place",
      false
    ]
  ],
  "calls": [
    [
      0,
      8,
      10,
      0,
      1
    ],
    [
      0,
      14,
      5,
      2,
      3
    ],
    [
      0,
      19,
      5,
      4,
      3
    ],
    [
      0,
      23,
      14,
      5,
      6
    ],
    [
      0,
      23,
      14,
      5,
      7
    ],
    [
      0,
      24,
      9,
      5,
      3
    ],
    [
      0,
      29,
      14,
      8,
      6
    ],
    [
      0,
      29,
      14,
      8,
      7
    ],
    [
      0,
      30,
      9,
      8,
      3
    ],
    [
      0,
      32,
      1,
      8,
      9
    ],
    [
      0,
      36,
      5,
      10,
      2
    ],
    [
      0,
      37,
      5,
      10,
      4
    ],
    [
      0,
      40,
      5,
      10,
      5
    ],
    [
      0,
      40,
      20,
      10,
      11
    ],
    [
      0,
      41,
      5,
      10,
      8
    ],
    [
      0,
      42,
      1,
      10,
      9
    ],
    [
      0,
      14,
      5,
      2,
      12
    ],
    [
      0,
      19,
      5,
      4,
      12
    ],
    [
      0,
      24,
      9,
      5,
      12
    ],
    [
      0,
      30,
      9,
      8,
      12
    ],
    [
      0,
      14,
      5,
      2,
      13
    ],
    [
      0,
      19,
      5,
      4,
      13
    ],
    [
      0,
      24,
      9,
      5,
      13
    ],
    [
      0,
      30,
      9,
      8,
      13
    ],
    [
      1,
      39,
      18,
      14,
      15
    ],
    [
      2,
      511,
      5,
      16,
      17
    ],
    [
      2,
      531,
      5,
      18,
      19
    ],
    [
      2,
      684,
      5,
      20,
      21
    ],
    [
      2,
      684,
      20,
      20,
      22
    ],
    [
      2,
      716,
      5,
      23,
      24
    ],
    [
      2,
      716,
      24,
      23,
      25
    ],
    [
      3,
      219,
      13,
      26,
      27
    ],
    [
      3,
      221,
      27,
      26,
      28
    ],
    [
      3,
      489,
      18,
      29,
      28
    ],
    [
      3,
      489,
      38,
      29,
      23
    ],
    [
      3,
      489,
      70,
      29,
      30
    ],
    [
      3,
      533,
      18,
      31,
      28
    ],
    [
      3,
      533,
      41,
      31,
      30
    ],
    [
      3,
      533,
      41,
      31,
      32
    ],
    [
      3,
      552,
      9,
      33,
      31
    ],
    [
      3,
      552,
      9,
      33,
      30
    ],
    [
      4,
      87,
      36,
      34,
      28
    ],
    [
      4,
      104,
      9,
      35,
      30
    ],
    [
      4,
      180,
      9,
      36,
      37
    ],
    [
      4,
      180,
      20,
      36,
      38
    ],
    [
      5,
      39,
      9,
      39,
      40
    ],
    [
      5,
      39,
      43,
      39,
      16
    ],
    [
      5,
      719,
      9,
      40,
      41
    ],
    [
      5,
      813,
      18,
      42,
      43
    ],
    [
      5,
      939,
      9,
      44,
      45
    ],
    [
      6,
      38,
      9,
      27,
      46
    ],
    [
      6,
      38,
      41,
      27,
      18
    ],
    [
      6,
      664,
      9,
      46,
      41
    ],
    [
      7,
      390,
      13,
      13,
      13
    ],
    [
      8,
      2105,
      27,
      47,
      48
    ],
    [
      7,
      339,
      5,
      3,
      49
    ],
    [
      9,
      733,
      9,
      6,
      50
    ],
    [
      10,
      89,
      19,
      50,
      51
    ],
    [
      10,
      92,
      13,
      50,
      52
    ],
    [
      10,
      92,
      21,
      50,
      39
    ],
    [
      10,
      94,
      26,
      50,
      53
    ],
    [
      10,
      95,
      17,
      50,
      44
    ],
    [
      10,
      97,
      17,
      50,
      42
    ],
    [
      10,
      100,
      25,
      50,
      28
    ],
    [
      10,
      135,
      1,
      7,
      30
    ],
    [
      10,
      135,
      1,
      7,
      54
    ],
    [
      10,
      135,
      1,
      54,
      45
    ],
    [
      10,
      135,
      1,
      54,
      53
    ],
    [
      10,
      135,
      1,
      54,
      30
    ],
    [
      10,
      135,
      1,
      54,
      30
    ],
    [
      10,
      135,
      1,
      54,
      28
    ],
    [
      10,
      135,
      1,
      54,
      30
    ],
    [
      10,
      135,
      1,
      54,
      55
    ],
    [
      10,
      135,
      1,
      7,
      52
    ],
    [
      10,
      135,
      1,
      7,
      30
    ],
    [
      10,
      135,
      1,
      7,
      27
    ],
    [
      10,
      135,
      1,
      7,
      53
    ],
    [
      10,
      135,
      1,
      7,
      52
    ],
    [
      10,
      135,
      1,
      7,
      39
    ],
    [
      11,
      97,
      11,
      56,
      20
    ],
    [
      12,
      100,
      40,
      57,
      58
    ],
    [
      12,
      196,
      18,
      59,
      28
    ],
    [
      12,
      196,
      41,
      59,
      19
    ],
    [
      12,
      196,
      71,
      59,
      60
    ],
    [
      0,
      39,
      14,
      10,
      61
    ],
    [
      0,
      39,
      14,
      10,
      62
    ],
    [
      13,
      216,
      30,
      63,
      34
    ],
    [
      13,
      224,
      9,
      64,
      35
    ],
    [
      14,
      89,
      27,
      65,
      66
    ],
    [
      14,
      89,
      42,
      65,
      60
    ],
    [
      14,
      160,
      34,
      67,
      66
    ],
    [
      14,
      160,
      49,
      67,
      60
    ],
    [
      14,
      231,
      9,
      68,
      69
    ],
    [
      15,
      1080,
      31,
      70,
      71
    ],
    [
      15,
      1081,
      10,
      70,
      35
    ],
    [
      15,
      1098,
      30,
      71,
      72
    ],
    [
      15,
      1099,
      10,
      71,
      36
    ],
    [
      15,
      1099,
      23,
      71,
      73
    ],
    [
      15,
      1100,
      5,
      71,
      74
    ],
    [
      15,
      1156,
      24,
      73,
      75
    ],
    [
      15,
      1156,
      24,
      73,
      76
    ],
    [
      15,
      1156,
      24,
      73,
      35
    ],
    [
      16,
      167,
      23,
      77,
      78
    ],
    [
      16,
      168,
      30,
      77,
      70
    ],
    [
      16,
      169,
      13,
      77,
      79
    ],
    [
      16,
      171,
      5,
      77,
      74
    ],
    [
      16,
      528,
      9,
      61,
      77
    ],
    [
      17,
      691,
      29,
      79,
      63
    ],
    [
      17,
      1140,
      19,
      80,
      64
    ],
    [
      17,
      1142,
      13,
      80,
      52
    ],
    [
      17,
      1142,
      21,
      80,
      27
    ],
    [
      17,
      1176,
      19,
      81,
      64
    ],
    [
      17,
      1178,
      13,
      81,
      52
    ],
    [
      17,
      1178,
      21,
      81,
      27
    ],
    [
      17,
      2497,
      18,
      11,
      56
    ],
    [
      17,
      2497,
      40,
      11,
      80
    ],
    [
      17,
      2881,
      13,
      9,
      82
    ],
    [
      17,
      2881,
      32,
      9,
      23
    ],
    [
      17,
      2881,
      62,
      9,
      81
    ]
  ]
}
*/
